#!/bin/sh

# displayline (Skim)
#
# Usage: displayline LINE PDFFILE [TEXSOURCEFILE]

# get arguments
line=$1
if [ "${0%forward-search.sh}" != "$0" ]; then
# if called as forward-search.sh, the order of arguments is different
source="$2"
file="$3"
else
file="$2"
[ $# -gt 2 ] && source="$3" || source="${file%.pdf}.tex"
fi

# expand relative paths
[ "${file:0:1}" == "/" ] || file="${PWD}/${file}"
[ "${source:0:1}" == "/" ] || source="${PWD}/${source}"

# pass arguments as NULL-separated string to osascript
# pass through cat to get them as raw bytes to preserve non-ASCII characters
echo -ne "${line}\x00${file}\x00${source}" | \
/usr/bin/osascript \
  -e "set theArgv to do shell script \"/bin/cat\"" \
  -e "set AppleScript's text item delimiters to ASCII character 0" \
  -e "set {theLine, theFile, theSource} to text items of theArgv" \
  -e "set theLine to theLine as integer" \
  -e "set theFile to POSIX file theFile" \
  -e "set theSource to POSIX file theSource" \
  -e "tell application \"Skim\"" \
  -e "  activate" \
  -e "  open theFile" \
  -e "  tell front document to go to TeX line theLine from theSource" \
  -e "end tell" -
